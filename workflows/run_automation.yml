name: Run TMA Automation

on:
  workflow_dispatch:
    inputs:
      station:
        description: 'ステーション名 (例: 大和テストST)'
        required: true
        default: 'テストステーション'
      plate:
        description: '車両ナンバー (例: 品川500あ1234)'
        required: true
        default: '品川500あ1234'
      reservation_time:
        description: '予約日時 (例: 2026-02-24 10:30)'
        required: true
        default: '2026-02-24 10:30'
  repository_dispatch:
    types: [webhook_from_gas]

jobs:
  run-script:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Japanese Fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-noto-cjk

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        # 元の requirements.txt を使うか、直接インストールするか環境に合わせてね
        run: |
          pip install selenium webdriver-manager

      - name: Run Automation Script (Manual / 手動テスト用)
        if: github.event_name == 'workflow_dispatch'
        run: |
          PAYLOAD="{\"station\": \"${{ github.event.inputs.station }}\", \"plate\": \"${{ github.event.inputs.plate }}\", \"reservation_time\": \"${{ github.event.inputs.reservation_time }}\"}"
          python main.py "$PAYLOAD"

      - name: Run Automation Script (Webhook / GASからの連携用)
        if: github.event_name == 'repository_dispatch'
        run: |
          PAYLOAD='${{ toJson(github.event.client_payload) }}'
          python main.py "$PAYLOAD"

      - name: Upload Evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: verification-screenshots
          path: evidence/
